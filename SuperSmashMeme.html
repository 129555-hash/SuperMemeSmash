<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Meme Bros Ultimate</title>
    <script type="module">
        // FIREBASE IMPORTS
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // SETUP GLOBAL VARS
        window.firebaseLoaded = false;
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;

        // AUTH FLOW
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Failed:", e);
                const el = document.getElementById('online-indicator');
                if(el) { el.innerText = "CONNECTION FAILED (Check Console)"; el.style.color = "red"; }
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                window.firebaseLoaded = true;
                console.log("Online ready. ID:", user.uid);
                // Update UI
                const ind = document.getElementById('online-indicator');
                const btn = document.getElementById('btn-online');
                if (ind) { ind.innerText = "SERVERS ONLINE"; ind.style.color = "#2ecc71"; }
                if (btn) { btn.style.opacity = "1.0"; btn.style.cursor = "pointer"; }
            }
        });

        // --- ONLINE FUNCTIONS ---

        window.createRoom = async () => {
            if (!currentUser) return alert("Wait for connection...");
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
            
            await setDoc(roomRef, {
                host: currentUser.uid,
                status: 'waiting',
                p1Char: 'doge',
                p2Char: 'frog',
                map: 'flat',
                cpuLevel: 5,
                lastUpdate: Date.now()
            });

            currentRoomId = roomId;
            window.playerRole = 'host'; // GLOBAL
            window.enterLobbyUI(roomId);
            listenToRoom(roomId);
        };

        window.joinRoom = async (roomId) => {
            if (!currentUser) return alert("Wait for connection...");
            if (!roomId || roomId.length !== 4) return alert("Invalid Room Code");
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
            
            // Check if exists first to avoid writing to bad paths
            // But Firestore client SDK handles writes optimistically
            await updateDoc(roomRef, {
                client: currentUser.uid,
                status: 'selecting'
            }).catch(e => alert("Room not found or full!"));

            currentRoomId = roomId;
            window.playerRole = 'client'; // GLOBAL
            window.enterLobbyUI(roomId);
            listenToRoom(roomId);
        };

        function listenToRoom(roomId) {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
            unsubscribeRoom = onSnapshot(roomRef, (snap) => {
                const data = snap.data();
                if (!data) return;
                window.handleRoomUpdate(data);
            });
        }

        // GAME STATE SYNC
        window.syncGameState = async (myState) => {
            if (!currentRoomId || !currentUser) return;
            const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentRoomId, 'players', window.playerRole);
            await setDoc(playerRef, myState).catch(()=>{});
        };

        window.listenToOpponent = () => {
            if (!currentRoomId) return;
            const oppRole = window.playerRole === 'host' ? 'client' : 'host';
            const oppRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentRoomId, 'players', oppRole);
            
            onSnapshot(oppRef, (snap) => {
                const data = snap.data();
                if (data) window.updateOpponent(data);
            });
        };

        // SYNC SELECTION
        window.updateRoomSelection = async (field, value) => {
            if (!currentRoomId) return;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentRoomId);
            await updateDoc(roomRef, { [field]: value });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Press+Start+2P&family=Roboto:wght@700&display=swap');

        :root {
            --p1-color: #3498db;
            --p2-color: #e74c3c;
            --cpu-color: #9b59b6;
            --ult-color: #f1c40f;
            --online-color: #2ecc71;
        }

        body { margin: 0; background: #111; overflow: hidden; font-family: 'Roboto', sans-serif; color: white; user-select: none; touch-action: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { display: block; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        /* SCREENS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* TYPOGRAPHY */
        h1 { font-family: 'Black Ops One'; font-size: 60px; background: -webkit-linear-gradient(#eee, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 20px 0; text-align: center; }
        h2 { font-family: 'Press Start 2P'; color: #fff; margin-bottom: 30px; font-size: 20px; }

        /* UI ELEMENTS */
        .menu-btn { font-family: 'Press Start 2P'; padding: 15px 30px; font-size: 16px; background: transparent; color: white; border: 4px solid white; cursor: pointer; margin: 10px; transition: 0.2s; }
        .menu-btn:hover { background: white; color: black; transform: scale(1.1); }
        .menu-btn.online-btn { border-color: var(--online-color); color: var(--online-color); opacity: 0.5; } /* Start dimmed */
        .menu-btn.online-btn:hover { background: var(--online-color); color: white; }

        #online-indicator { font-family: 'Press Start 2P'; font-size: 10px; color: #7f8c8d; margin-top: 5px; letter-spacing: 1px; animation: pulseText 2s infinite; }
        @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* INPUTS */
        input.code-input { font-family: 'Press Start 2P'; font-size: 20px; padding: 10px; text-align: center; width: 150px; margin: 10px; background: #333; color: white; border: 2px solid #666; }

        /* CPU CONTROLS */
        #cpu-controls { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #cpu-toggle { font-size: 14px; padding: 10px 20px; border-color: var(--p2-color); color: var(--p2-color); }
        #cpu-toggle.cpu-active { background: var(--cpu-color); color: white; border-color: white; }
        #cpu-level-container { display: none; align-items: center; gap: 10px; font-family: 'Press Start 2P'; font-size: 12px; color: var(--cpu-color); }
        input[type=range] { width: 150px; accent-color: var(--cpu-color); cursor: pointer; }

        /* CHAR SELECT */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 800px; }
        .char-card { background: #333; border: 4px solid #555; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .char-card:hover { transform: scale(1.05); border-color: white; }
        .char-icon { font-size: 40px; display: block; margin-bottom: 5px; }
        .char-name { font-weight: bold; font-size: 12px; display: block; }
        .selected-p1 { border-color: var(--p1-color) !important; box-shadow: 0 0 15px var(--p1-color); }
        .selected-p2 { border-color: var(--p2-color) !important; box-shadow: 0 0 15px var(--p2-color); }

        /* MAP SELECT */
        .map-grid { display: flex; gap: 20px; }
        .map-card { width: 200px; height: 150px; background: #444; border: 3px solid #666; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-direction: column; }
        .map-card:hover { border-color: #fff; }
        .map-preview { font-size: 40px; margin-bottom: 10px; }

        /* MOVES LIST */
        #moves-content { width: 90%; height: 70%; overflow-y: auto; background: #222; border: 2px solid #555; padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; box-sizing: border-box; }
        .move-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; display: flex; align-items: flex-start; gap: 15px; border: 1px solid #444; }
        .move-icon { font-size: 40px; min-width: 50px; }
        .move-details { text-align: left; font-size: 12px; line-height: 1.8; color: #ccc; width: 100%; }
        .move-input { color: #e74c3c; font-weight: bold; font-size: 10px; background: #444; padding: 2px 5px; border-radius: 4px; margin-right: 5px;}
        .ult-input { color: var(--ult-color); background: #443300; }

        /* HUD */
        #hud { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; font-family: 'Black Ops One'; }
        .player-hud { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; text-align: center; min-width: 150px; border-top: 5px solid #fff; }
        .p1-hud { border-color: var(--p1-color); } .p2-hud { border-color: var(--p2-color); }
        .p2-cpu { border-color: var(--cpu-color) !important; }
        .percent { font-size: 48px; color: white; text-shadow: 2px 2px 0 #000; }
        .stocks { font-size: 24px; color: #ddd; margin-top: 5px; letter-spacing: 5px;}
        .ult-container { width: 100%; height: 10px; background: #333; margin-top: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #555; }
        .ult-bar { height: 100%; width: 0%; background: #555; transition: width 0.1s; }
        .ult-ready .ult-bar { background: var(--ult-color); box-shadow: 0 0 10px var(--ult-color); animation: ultPulse 0.5s infinite alternate; }
        @keyframes ultPulse { from { opacity: 0.5; } to { opacity: 1; text-shadow: 0 0 5px var(--ult-color); } }

        /* LOBBY INFO */
        #lobby-info { margin-bottom: 20px; font-family: 'Press Start 2P'; color: var(--online-color); text-align: center; line-height: 1.5; }
        #room-code-display { font-size: 30px; color: white; margin: 10px 0; display: block; letter-spacing: 5px; }

        /* MOBILE */
        #mobile-controls { display: none; position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .touch-btn { pointer-events: auto; position: absolute; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; font-family: sans-serif; backdrop-filter: blur(2px); }
        .touch-btn:active { background: rgba(255,255,255,0.3); }
        .dpad { width: 60px; height: 60px; font-size: 24px; }
        #btn-left { bottom: 30px; left: 20px; } #btn-right { bottom: 30px; left: 90px; } #btn-up { bottom: 100px; left: 55px; } #btn-down { bottom: 30px; left: 55px; }
        .action-btn { width: 70px; height: 70px; font-size: 18px; }
        #btn-atk { bottom: 40px; right: 30px; border-color: #e74c3c; background: rgba(231, 76, 60, 0.2); }
        #btn-jump { bottom: 60px; right: 110px; border-color: #2ecc71; background: rgba(46, 204, 113, 0.2); }
        #btn-ult { bottom: 120px; right: 40px; width: 50px; height: 50px; border-color: var(--ult-color); background: rgba(241, 196, 15, 0.3); font-size: 12px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<div id="hud" class="hidden">
    <div class="player-hud p1-hud">
        <div id="p1-name">P1</div>
        <div class="percent" id="p1-pct">0%</div>
        <div class="stocks" id="p1-stocks">‚óè‚óè‚óè</div>
        <div class="ult-container"><div id="p1-ult-bar" class="ult-bar"></div></div>
    </div>
    <div class="player-hud p2-hud" id="p2-hud-box">
        <div id="p2-name">P2</div>
        <div class="percent" id="p2-pct">0%</div>
        <div class="stocks" id="p2-stocks">‚óè‚óè‚óè</div>
        <div class="ult-container"><div id="p2-ult-bar" class="ult-bar"></div></div>
    </div>
</div>

<!-- TITLE SCREEN -->
<div id="title-screen" class="screen">
    <h1>SUPER<br>MEME BROS<br>ULTIMATE</h1>
    <button class="menu-btn" onclick="startLocal()">LOCAL / CPU</button>
    <button id="btn-online" class="menu-btn online-btn" onclick="goToOnlineMenu()">ONLINE PVP</button>
    <div id="online-indicator">CONNECTING TO SERVERS...</div>
    <button class="menu-btn" onclick="showMoves()">MOVES LIST</button>
    <p style="color: #888; font-size: 12px; margin-top: 20px;">Recommended: Play with a friend (Keyboard) or Solo (Mobile)</p>
</div>

<!-- ONLINE MENU -->
<div id="online-menu" class="screen hidden">
    <h2>ONLINE LOBBY</h2>
    <button class="menu-btn online-btn" onclick="window.createRoom()">CREATE ROOM</button>
    <div style="margin: 20px 0;">
        <input type="text" id="room-code-input" class="code-input" placeholder="CODE" maxlength="4">
        <button class="menu-btn" onclick="window.joinRoom(document.getElementById('room-code-input').value)">JOIN</button>
    </div>
    <button class="menu-btn" onclick="location.reload()">BACK</button>
</div>

<!-- MOVES SCREEN -->
<div id="moves-screen" class="screen hidden">
    <h2>CHARACTER MOVES</h2>
    <div id="moves-content"></div>
    <button class="menu-btn" onclick="hideMoves()" style="margin-top: 20px;">BACK</button>
</div>

<!-- CHAR SELECT (SHARED) -->
<div id="char-select" class="screen hidden">
    <div id="lobby-info" class="hidden">
        ROOM ID: <span id="room-code-display">----</span>
        <span id="connection-status">WAITING FOR PLAYER...</span>
    </div>
    <h2>SELECT FIGHTER</h2>
    <h3 id="select-instruction">P1 CHOOSE</h3>
    <div class="char-grid" id="char-grid"></div>
    
    <div id="cpu-controls">
        <button id="cpu-toggle" class="menu-btn" onclick="toggleCpu()">P2: HUMAN</button>
        <div id="cpu-level-container">
            LVL <span id="cpu-level-val">5</span>
            <input type="range" id="cpu-level-slider" min="1" max="9" value="5" oninput="updateCpuLevel(this.value)">
        </div>
    </div>
</div>

<!-- MAP SELECT -->
<div id="map-select" class="screen hidden">
    <h2>SELECT STAGE</h2>
    <div class="map-grid" id="map-grid"></div>
</div>

<!-- CONTROLS HINT -->
<div id="controls-hint" class="screen hidden" style="background: rgba(0,0,0,0.8); pointer-events: auto;" onclick="startGameLoop()">
    <h2>READY?</h2>
    <div style="display: flex; gap: 50px; text-align: left;">
        <div>
            <strong style="color: var(--p1-color)">PLAYER 1</strong><br>
            WASD + F<br>
            ULT: R
        </div>
        <div id="p2-controls-text">
            <strong style="color: var(--p2-color)">PLAYER 2</strong><br>
            Arrows + L<br>
            ULT: Shift
        </div>
    </div>
    <h3 class="pulse" style="margin-top: 50px;">CLICK TO FIGHT</h3>
</div>

<!-- GAME OVER -->
<div id="game-over" class="screen hidden">
    <h1 id="winner-display">GAME!</h1>
    <button class="menu-btn" onclick="location.reload()">MAIN MENU</button>
</div>

<!-- MOBILE UI -->
<div id="mobile-controls">
    <div id="btn-left" class="touch-btn dpad">‚Üê</div>
    <div id="btn-right" class="touch-btn dpad">‚Üí</div>
    <div id="btn-up" class="touch-btn dpad">‚Üë</div>
    <div id="btn-down" class="touch-btn dpad">‚Üì</div>
    <div id="btn-atk" class="touch-btn action-btn">ATK</div>
    <div id="btn-jump" class="touch-btn action-btn">JMP</div>
    <div id="btn-ult" class="touch-btn">ULT</div>
</div>

<script>
// --- AUDIO SYSTEM ---
const sfx = {
    ctx: null,
    init: function() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play: function(type) {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination);
        if (type === 'jump') { osc.type='square'; osc.frequency.setValueAtTime(150,t); osc.frequency.linearRampToValueAtTime(300,t+0.1); gain.gain.setValueAtTime(0.1,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.1); osc.start(t); osc.stop(t+0.1); }
        else if (type === 'hit') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100,t); osc.frequency.exponentialRampToValueAtTime(10,t+0.1); gain.gain.setValueAtTime(0.2,t); osc.start(t); osc.stop(t+0.1); }
        else if (type === 'ult') { osc.type='sine'; osc.frequency.setValueAtTime(400,t); osc.frequency.linearRampToValueAtTime(800,t+0.5); gain.gain.setValueAtTime(0.3,t); osc.start(t); osc.stop(t+1.0); }
        else if (type === 'coin') { osc.type='sine'; osc.frequency.setValueAtTime(1000,t); gain.gain.setValueAtTime(0.1,t); gain.gain.linearRampToValueAtTime(0,t+0.1); osc.start(t); osc.stop(t+0.1); }
    }
};

// --- CONFIG ---
const CHARACTERS = [
    { id: 'doge', name: 'Doge', icon: 'üêï', speed: 1.1, weight: 1.0, power: 1.0, jump: 1.0, desc: "Balanced", 
      moves: { up: "To The Moon", down: "Such Heavy", side: "Zoomies", ult: "MOON CRASH" } },
    { id: 'frog', name: 'Pepe', icon: 'üê∏', speed: 0.8, weight: 1.4, power: 1.3, jump: 0.9, desc: "Heavy", 
      moves: { up: "High Hop", down: "Sad Stomp", side: "Ree Punch", ult: "TEAR FLOOD" } },
    { id: 'cat', name: 'Pop Cat', icon: 'üôÄ', speed: 1.4, weight: 0.7, power: 0.8, jump: 1.2, desc: "Speed", 
      moves: { up: "Pop Jump", down: "Fast Fall", side: "Scratch Dash", ult: "POP STORM" } },
    { id: 'capy', name: 'Capy', icon: 'ü•î', speed: 0.6, weight: 1.8, power: 1.5, jump: 0.8, desc: "Tank", 
      moves: { up: "Chill Rise", down: "Body Slam", side: "Headbutt", ult: "PULL UP" } },
    { id: 'spongy', name: 'Spongy', icon: 'üßΩ', speed: 1.0, weight: 0.9, power: 1.1, jump: 1.3, desc: "Aerial", 
      moves: { up: "Rainbow", down: "Head Out", side: "Karate", ult: "IMAGINATION" } },
    { id: 'sanic', name: 'Sanic', icon: 'ü¶î', speed: 1.8, weight: 0.8, power: 0.9, jump: 1.1, desc: "Fast", 
      moves: { up: "Spring", down: "Spindash", side: "Gotta Go Fast", ult: "LIGHT SPEED" } },
    { id: 'chad', name: 'Chad', icon: 'üóø', speed: 0.5, weight: 2.0, power: 1.4, jump: 0.7, desc: "Boss", 
      moves: { up: "Giga Chin", down: "Flex", side: "Strut", ult: "GIGA STUN" } },
    { id: 'troll', name: 'Troll', icon: 'üë∫', speed: 1.2, weight: 1.0, power: 1.0, jump: 1.5, desc: "Tricky", 
      moves: { up: "Float", down: "Glitch", side: "Problem?", ult: "U MAD?" } }
];

const MAPS = [
    { id: 'flat', name: 'The Flat', icon: 'üõë', type: 'flat', color: '#546E7A' },
    { id: 'plat', name: 'Tri-Plat', icon: 'üèóÔ∏è', type: 'platforms', color: '#2E7D32' },
    { id: 'edge', name: 'The Edge', icon: '‚õ∞Ô∏è', type: 'edge', color: '#4e342e' }
];

// --- GLOBALS ---
const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
let gameState = 'TITLE';
let p1Char = null, p2Char = null;
let p2IsCpu = false, isOnline = false, cpuLevel = 5;
let players = [], platforms = [], ultEffects = [], items = [];
let itemTimer = 0;
let camera = { x: 0, y: 0, zoom: 1 };
let shake = 0, hitStop = 0;
const keys = {};
const touchInput = { left:false, right:false, up:false, down:false, atk:false, jump:false, ult:false };

// --- INPUT LISTENERS ---
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// --- MENU LOGIC ---
function startLocal() {
    sfx.init(); isOnline = false;
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('char-select').classList.remove('hidden');
    document.getElementById('cpu-controls').classList.remove('hidden');
    renderCharGrid();
}

function goToOnlineMenu() {
    if (!window.firebaseLoaded) return; // Prevent click if not ready
    sfx.init(); isOnline = true;
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('online-menu').classList.remove('hidden');
}

window.enterLobbyUI = (roomId) => {
    document.getElementById('online-menu').classList.add('hidden');
    document.getElementById('char-select').classList.remove('hidden');
    document.getElementById('lobby-info').classList.remove('hidden');
    document.getElementById('room-code-display').innerText = roomId;
    document.getElementById('cpu-controls').classList.add('hidden'); // No CPU online
    renderCharGrid();
}

// SHARED LOGIC
window.handleRoomUpdate = (data) => {
    if (data.p1Char && p1Char?.id !== data.p1Char) { p1Char = CHARACTERS.find(c => c.id === data.p1Char); highlightChar(data.p1Char, 1); }
    if (data.p2Char && p2Char?.id !== data.p2Char) { p2Char = CHARACTERS.find(c => c.id === data.p2Char); highlightChar(data.p2Char, 2); }
    if (data.client && document.getElementById('connection-status').innerText.includes("WAITING")) {
        document.getElementById('connection-status').innerText = "PLAYER 2 CONNECTED!"; document.getElementById('connection-status').style.color = "#2ecc71";
    }
    if (data.status === 'playing' && gameState !== 'GAME') { startGameLoop(); window.listenToOpponent(); }
}

function showMoves() {
    sfx.init();
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('moves-screen').classList.remove('hidden');
    const c = document.getElementById('moves-content');
    c.innerHTML = '';
    CHARACTERS.forEach(char => {
        c.innerHTML += `
        <div class="move-card">
            <div class="move-icon">${char.icon}</div>
            <div class="move-details">
                <strong style="font-size:14px; color: #fff;">${char.name}</strong> (${char.desc})<br>
                <span class="move-input">SIDE</span> ${char.moves.side}<br>
                <span class="move-input">UP</span> ${char.moves.up}<br>
                <span class="move-input">DOWN</span> ${char.moves.down}<br>
                <span class="move-input ult-input">ULT</span> ${char.moves.ult}
            </div>
        </div>`;
    });
}
function hideMoves() { document.getElementById('moves-screen').classList.add('hidden'); document.getElementById('title-screen').classList.remove('hidden'); }

function toggleCpu() { 
    p2IsCpu = !p2IsCpu; 
    document.getElementById('cpu-toggle').innerText = p2IsCpu ? "P2: CPU" : "P2: HUMAN"; 
    document.getElementById('cpu-toggle').classList.toggle('cpu-active', p2IsCpu);
    document.getElementById('cpu-level-container').style.display = p2IsCpu ? 'flex' : 'none';
}

function updateCpuLevel(val) { cpuLevel = parseInt(val); document.getElementById('cpu-level-val').innerText = cpuLevel; }

function renderCharGrid() {
    const g = document.getElementById('char-grid'); g.innerHTML = '';
    CHARACTERS.forEach(c => {
        const d = document.createElement('div'); d.className = 'char-card'; d.id = `card-${c.id}`;
        d.innerHTML = `<span class="char-icon">${c.icon}</span><span class="char-name">${c.name}</span>`;
        d.onclick = () => selectCharacter(c); g.appendChild(d);
    });
}

function highlightChar(charId, playerNum) {
    const cards = document.getElementsByClassName('char-card'); for(let c of cards) c.classList.remove(`selected-p${playerNum}`);
    const el = document.getElementById(`card-${charId}`); if (el) el.classList.add(`selected-p${playerNum}`);
}

async function selectCharacter(c) {
    sfx.play('jump');
    if (isOnline) {
        const role = window.playerRole;
        if (role === 'host') { p1Char = c; window.updateRoomSelection('p1Char', c.id); } 
        else { p2Char = c; window.updateRoomSelection('p2Char', c.id); }
        if (role === 'host' && p1Char && p2Char) setTimeout(() => window.updateRoomSelection('status', 'playing'), 1000);
    } else {
        if (!p1Char) { p1Char = c; highlightChar(c.id, 1); document.getElementById('select-instruction').innerText = "PLAYER 2 CHOOSE"; document.getElementById('select-instruction').style.color = "var(--p2-color)"; } 
        else if (!p2Char) { p2Char = c; highlightChar(c.id, 2); setTimeout(goToMapSelect, 500); }
    }
}

function goToMapSelect() {
    document.getElementById('char-select').classList.add('hidden'); document.getElementById('map-select').classList.remove('hidden');
    const g = document.getElementById('map-grid'); g.innerHTML = '';
    MAPS.forEach(m => {
        const d = document.createElement('div'); d.className = 'map-card';
        d.innerHTML = `<div class="map-preview">${m.icon}</div><div>${m.name}</div>`;
        d.onclick = () => { selectedMap = m; document.getElementById('map-select').classList.add('hidden'); document.getElementById('controls-hint').classList.remove('hidden'); if(p2IsCpu) document.getElementById('p2-controls-text').innerHTML = `<strong style="color:var(--cpu-color)">CPU LVL ${cpuLevel}</strong><br>Good luck.`; };
        g.appendChild(d);
    });
}

function startGameLoop() {
    document.getElementById('char-select').classList.add('hidden'); // Ensure char select is gone
    document.getElementById('controls-hint').classList.add('hidden'); document.getElementById('hud').classList.remove('hidden');
    if(p2IsCpu) document.getElementById('p2-hud-box').classList.add('p2-cpu');
    resize(); initGame(); gameState = 'GAME'; loop();
}

// --- GAMEPLAY ---

function initGame() {
    if (!p1Char) p1Char = CHARACTERS[0]; if (!p2Char) p2Char = CHARACTERS[1];
    if (!selectedMap) selectedMap = MAPS[0];
    
    platforms = []; items = []; ultEffects = []; itemTimer = 0;
    const gy=200;
    if(selectedMap.type==='flat') platforms.push({x:-600,y:gy,w:1200,h:500,type:'solid',color:selectedMap.color});
    else if(selectedMap.type==='platforms') { platforms.push({x:-500,y:gy,w:1000,h:500,type:'solid',color:selectedMap.color}); platforms.push({x:-300,y:gy-150,w:150,h:20,type:'pass',color:'#ddd'}); platforms.push({x:150,y:gy-150,w:150,h:20,type:'pass',color:'#ddd'}); platforms.push({x:-75,y:gy-280,w:150,h:20,type:'pass',color:'#ddd'}); }
    else if(selectedMap.type==='edge') platforms.push({x:-200,y:gy,w:400,h:500,type:'solid',color:selectedMap.color});

    // Player Setup
    let p1Ctrl = !isOnline || window.playerRole === 'host';
    let p2Ctrl = !isOnline && !p2IsCpu;
    let p2Cpu = !isOnline && p2IsCpu;
    let p2Remote = isOnline && window.playerRole === 'host';
    let p1Remote = isOnline && window.playerRole === 'client';

    players = [
        new Fighter(1, p1Char, -200, 0, p1Ctrl, false, p1Remote),
        new Fighter(2, p2Char, 200, 0, (isOnline && window.playerRole==='client') || p2Ctrl, p2Cpu, p2Remote)
    ];
    
    document.getElementById('p1-name').innerText = p1Char.name; document.getElementById('p2-name').innerText = p2Char.name;
    updateHUD();
}

class Item {
    constructor() {
        this.type = Math.random() > 0.8 ? 'nyan' : (Math.random() > 0.5 ? 'hammer' : 'coin');
        this.active = true; this.w = 30; this.h = 30;
        if (this.type === 'nyan') { this.y = Math.random()*400-200; this.vx=(Math.random()<0.5?1:-1)*12; this.x=this.vx>0?-600:600; this.vy=0; this.icon='üåà'; }
        else { this.x=(Math.random()*600)-300; this.y=-400; this.vx=0; this.vy=0; this.icon=this.type==='hammer'?'üî®':'ü™ô'; }
    }
    update() {
        if(!this.active) return;
        if(this.type==='nyan') { this.x+=this.vx; if(this.x<-1500||this.x>1500) this.active=false; }
        else { this.vy+=0.5; this.y+=this.vy; for(let p of platforms) if(this.vy>0&&this.y+this.h>p.y&&this.y+this.h<p.y+30&&this.x+this.w>p.x&&this.x<p.x+p.w) { this.y=p.y-this.h; this.vy=0; } if(this.y>800) this.active=false; }
    }
    draw() { if(!this.active) return; ctx.font="30px Arial"; ctx.fillText(this.icon, this.x, this.y+30); }
}

class Fighter {
    constructor(id, stats, x, y, isLocal, isCpu, isRemote) {
        this.id = id; this.stats = stats; this.x = x; this.y = y; this.w = 50; this.h = 50;
        this.vx = 0; this.vy = 0; this.pct = 0; this.stocks = 3; this.ult = 0;
        this.facingRight = id === 1; this.isLocal = isLocal; this.isCpu = isCpu; this.isRemote = isRemote;
        this.grounded = false; this.jumps = 2; this.stun = 0; this.invincible = 0; this.attackCooldown = 0;
        this.targetX = x; this.targetY = y; this.hasHammer = false;
    }

    update() {
        if (this.stocks <= 0) return;
        this.ult = Math.min(100, this.ult + 0.05);

        if (this.isRemote) {
            this.x += (this.targetX - this.x) * 0.3; this.y += (this.targetY - this.y) * 0.3; return;
        }

        let l=false, r=false, u=false, d=false, atk=false, jmp=false, ult=false;
        
        if (this.isCpu) {
            let target = players.find(p => p.id !== this.id);
            const inputs = this.runAI(target);
            l=inputs.l; r=inputs.r; u=inputs.u; d=inputs.d; atk=inputs.atk; jmp=inputs.jmp;
        } 
        else if (this.isLocal) {
            if (this.id === 1 || isOnline) { 
                l=keys['a']||touchInput.left; r=keys['d']||touchInput.right; u=keys['w']||touchInput.up; d=keys['s']||touchInput.down; 
                atk=keys['f']||touchInput.atk; jmp=keys['w']||touchInput.jump; ult=keys['r']||touchInput.ult;
            } else {
                l=keys['ArrowLeft']; r=keys['ArrowRight']; u=keys['ArrowUp']; d=keys['ArrowDown']; atk=keys['l']; jmp=keys['ArrowUp']; ult=keys['Shift'];
            }
        }

        if (this.stun > 0) { this.stun--; this.physics(); return; }
        if (ult && this.ult >= 100) this.fireUlt();

        const spd = 1.5 * this.stats.speed;
        if (l) { this.vx -= spd; this.facingRight = false; }
        if (r) { this.vx += spd; this.facingRight = true; }
        this.vx *= 0.85;

        if (jmp && !this.prevJump && this.jumps > 0) { this.vy = -14 * this.stats.jump; this.jumps--; sfx.play('jump'); }
        this.prevJump = jmp;

        if (this.attackCooldown > 0) this.attackCooldown--;
        else if (atk) this.attack(u, d, l, r);

        this.physics();
        if (this.invincible > 0) this.invincible--;
        this.checkItems();

        if (isOnline && this.isLocal && Math.random() < 0.2) { 
            window.syncGameState({ x: Math.round(this.x), y: Math.round(this.y), pct: Math.round(this.pct), facingRight: this.facingRight, stocks: this.stocks, anim: atk ? 'atk' : 'idle' });
        }
    }

    runAI(t) {
        const i = {l:0,r:0,u:0,d:0,atk:0,jmp:0};
        if (!t) return i;
        if (cpuLevel === 1) { if (Math.random() < 0.1) i.r = true; if (Math.random() < 0.1) i.l = true; if (Math.random() < 0.02) i.atk = true; if (this.y > 400 && Math.random() < 0.2) i.jmp = true; return i; }
        let rt = (10 - cpuLevel) * 50 + 200;
        if (this.y > rt || Math.abs(this.x) > 800) { if (this.x < 0) i.r = 1; else i.l = 1; if (this.jumps > 0 && this.vy > 0) i.jmp = 1; if (this.jumps == 0) { i.u = 1; i.atk = 1; } return i; }
        const dx = t.x - this.x, dy = t.y - this.y; let err = (9 - cpuLevel) * 20;
        if (Math.abs(dx) > 60 + err) { if (dx > 0) i.r = 1; else i.l = 1; }
        if (dy < -100 && this.jumps > 0 && Math.random() < (cpuLevel * 0.05)) i.jmp = 1;
        if (Math.sqrt(dx*dx+dy*dy) < 150 && Math.random() < (cpuLevel * 0.05)) { i.atk = 1; if (dy > 50) i.d = 1; else if (dy < -50) i.u = 1; else if (Math.abs(dx) > 20) { if(dx>0)i.r=1; else i.l=1; } }
        return i;
    }

    syncFromRemote(data) { this.targetX = data.x; this.targetY = data.y; this.pct = data.pct; this.facingRight = data.facingRight; this.stocks = data.stocks; if (data.anim === 'atk') this.attackCooldown = 10; updateHUD(); }

    checkItems() {
        items.forEach(i => {
            if(i.active && this.x<i.x+i.w && this.x+this.w>i.x && this.y<i.y+i.h && this.y+this.h>i.y) {
                if(i.type==='hammer') { this.hasHammer=true; i.active=false; sfx.play('coin'); }
                else if(i.type==='coin') { this.pct=Math.max(0,this.pct-20); i.active=false; sfx.play('coin'); updateHUD(); }
                else if(i.type==='nyan') { this.takeHit(20*(i.vx>0?1:-1), -10, 15); i.active=false; }
            }
        });
    }

    attack(u, d, l, r) {
        this.attackCooldown = 30; sfx.play('hit');
        let ox = this.facingRight ? 50 : -60, dmg=10, kbx=10, kby=-10, frame=5;
        
        if (this.hasHammer) { this.hasHammer=false; this.attackCooldown=45; this.hitbox={x:this.x+(this.facingRight?0:-40),y:this.y-20,w:90,h:70,active:true,owner:this.id,kbx:25,kby:-15,dmg:25,frame:5}; return; }

        const s = this.stats;
        if (u) { this.vy = -12*s.jump; kby=-15; dmg=12; }
        else if (d) { dmg=15; kby=15; }
        else if (l||r) { this.vx=(this.facingRight?1:-1)*15; dmg=12; kbx=15; }
        this.hitbox = { x: this.x + ox, y: this.y, w: 60, h: 50, active: true, owner: this.id, kbx:kbx*s.power, kby:kby*s.power, dmg:dmg*s.power, frame:frame };
    }

    fireUlt() {
        this.ult = 0; sfx.play('ult'); shake = 30; updateHUD();
        let t = players.find(p => p.id !== this.id);
        if (this.stats.id === 'doge') ultEffects.push({type: 'moon', x: t.x, y: -500, life: 50});
        else t.takeHit(0, -30, 40); 
    }

    takeHit(kbx, kby, dmg) {
        if (this.invincible > 0) return;
        this.pct += dmg; this.ult = Math.min(100, this.ult + dmg); 
        
        let sc = 0.5 + (this.pct*0.025), wm = 1.0/this.stats.weight;
        if(kbx!==0) { let opp = players.find(p=>p.id!==this.id); this.vx = (this.x<opp.x?-1:1) * Math.abs(kbx*sc*wm); }
        else this.vx = (Math.random()-0.5)*Math.abs(kbx*sc*wm);
        this.vy = kby*sc*wm;

        this.invincible = 10; sfx.play('hit'); hitStop = 5;
        updateHUD();
    }

    physics() {
        this.vy += 0.6; if(this.vy>25)this.vy=25;
        this.x += this.vx; this.y += this.vy;
        this.grounded = false;
        for(let p of platforms) {
            let pt=p.y, ft=this.y+this.h;
            if(this.vy>=0 && ft>=pt && ft<=pt+Math.max(25,this.vy+10) && this.x+this.w>p.x && this.x<p.x+p.w) { this.y=p.y-this.h; this.vy=0; this.grounded=true; this.jumps=2; }
            if(p.type==='solid' && this.vy<0 && this.x+this.w>p.x && this.x<p.x+p.w && this.y<p.y+p.h && ft>p.y+p.h) { this.y=p.y+p.h; this.vy=0; }
        }
        if(this.y>800) this.die();
    }

    die() {
        this.stocks--; this.pct=0; this.x=0; this.y=-200; this.vx=0; this.vy=0;
        if (this.stocks<=0) endGame(this.id===1?2:1);
        updateHUD();
    }

    draw() {
        if (this.stocks <= 0) return;
        ctx.save();
        ctx.translate(this.x+this.w/2, this.y+this.h/2);
        if (this.facingRight) ctx.scale(-1, 1);
        ctx.font = "50px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(this.stun>0?"üòµ":this.stats.icon, 0, 5);
        if(this.hasHammer) { ctx.font="20px Arial"; ctx.fillText('üî®', 25, -25); }
        ctx.restore();
        
        if (this.hitbox && this.hitbox.active) {
            ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fillRect(this.hitbox.x, this.hitbox.y, this.hitbox.w, this.hitbox.h);
            this.hitbox.frame--; if(this.hitbox.frame<=0) this.hitbox.active=false;
        }
        ctx.fillStyle = this.id === 1 ? '#3498db' : (this.isCpu ? '#9b59b6' : '#e74c3c');
        ctx.font="bold 12px sans-serif"; ctx.fillText(this.isRemote?`NET`:`P${this.id}`, this.x+15, this.y-10);
    }
}

window.updateOpponent = (data) => {
    const p = window.playerRole === 'host' ? players[1] : players[0];
    if (p) p.syncFromRemote(data);
};

function updateHUD() {
    players.forEach(p => {
        const pre = p.id===1?'p1':'p2';
        document.getElementById(`${pre}-pct`).innerText = Math.floor(p.pct) + '%';
        document.getElementById(`${pre}-stocks`).innerText = '‚óè'.repeat(p.stocks);
        document.getElementById(`${pre}-ult-bar`).style.width = p.ult + '%';
        if(p.ult>=100) document.getElementById(`${pre}-ult-bar`).parentNode.classList.add('ult-ready');
        else document.getElementById(`${pre}-ult-bar`).parentNode.classList.remove('ult-ready');
    });
}

function endGame(wid) { gameState='GAMEOVER'; document.getElementById('game-over').classList.remove('hidden'); const p=wid===1?p1Char:p2Char; document.getElementById('winner-display').innerText=`GAME!\n${p.name} WINS`; }

// --- LOOP ---
function loop() {
    if (gameState !== 'GAME') return;
    if (hitStop > 0) { hitStop--; players.forEach(p=>p.draw()); requestAnimationFrame(loop); return; }

    itemTimer++; if (itemTimer > 400) { if (Math.random() < 0.7) items.push(new Item()); itemTimer = 0; }

    players.forEach(p => p.update());
    items.forEach(i => i.update());
    
    for(let i=ultEffects.length-1; i>=0; i--) {
        let e = ultEffects[i]; e.life--;
        if(e.type==='moon') { e.y+=15; players.forEach(p=>{if(Math.abs(p.x-e.x)<100&&Math.abs(p.y-e.y)<100)p.takeHit(0,20,2)}); }
        if(e.life<=0) ultEffects.splice(i,1);
    }

    players.forEach(atk => {
        if (atk.hitbox && atk.hitbox.active) {
            players.forEach(def => {
                if (atk.id !== def.id && atk.hitbox.x < def.x + def.w && atk.hitbox.x + atk.hitbox.w > def.x && atk.hitbox.y < def.y + def.h && atk.hitbox.y + atk.hitbox.h > def.y) {
                    let dir = atk.facingRight ? 1 : -1;
                    def.takeHit(Math.abs(atk.hitbox.kbx) * dir, atk.hitbox.kby, atk.hitbox.dmg);
                    atk.hitbox.active = false;
                }
            });
        }
    });

    updateCamera(); draw(); requestAnimationFrame(loop);
}

function updateCamera() {
    if (players.length < 2) return;
    let mx = (players[0].x + players[1].x)/2, my = (players[0].y + players[1].y)/2;
    let d = Math.sqrt(Math.pow(players[1].x-players[0].x,2));
    let tz = Math.max(0.5, Math.min(1.2, 1000/(d+200)));
    camera.x += (mx - camera.x)*0.1; camera.y += (my - camera.y)*0.1; camera.zoom += (tz - camera.zoom)*0.05;
}

function draw() {
    ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const grad = ctx.createLinearGradient(0,0,0,canvas.height); grad.addColorStop(0, '#87CEEB'); grad.addColorStop(1, '#E0F7FA'); ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    if (shake > 0) { ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2); shake*=0.9; }
    ctx.scale(camera.zoom, camera.zoom); ctx.translate(-camera.x, -camera.y);

    platforms.forEach(p => { ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.w,p.h); });
    items.forEach(i => i.draw());
    ultEffects.forEach(e => { if(e.type==='moon') { ctx.font="200px Arial"; ctx.fillText('üåö', e.x-100, e.y); } });
    players.forEach(p => p.draw());
    ctx.restore();
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);

if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
    document.getElementById('mobile-controls').style.display = 'block';
    const bind = (id, k) => { const el = document.getElementById(id); el.addEventListener('touchstart', (e)=>{e.preventDefault();touchInput[k]=true;}); el.addEventListener('touchend', (e)=>{e.preventDefault();touchInput[k]=false;}); };
    bind('btn-left','left'); bind('btn-right','right'); bind('btn-up','up'); bind('btn-down','down'); bind('btn-atk','atk'); bind('btn-jump','jump'); bind('btn-ult','ult');
}
resize();
</script>
</body>
</html>